# GitLab CI Rules Configuration
# This file contains reusable rule sets for different scenarios

# Base rules for different pipeline sources
.rules:basic-pipeline:
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

.rules:merge-request-only:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

.rules:main-branch-only:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

.rules:manual-on-main:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
      allow_failure: true

.rules:scheduled-only:
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"

# Rules for file-based changes
.rules:frontend-changes:
  rules:
    - changes:
        - "frontend/**/*"
        - "*.html"
        - "*.css"
        - "*.js"
        - "package.json"
        - "package-lock.json"

.rules:backend-changes:
  rules:
    - changes:
        - "backend/**/*"
        - "*.py"
        - "*.java"
        - "*.go"
        - "requirements.txt"
        - "pom.xml"
        - "go.mod"

.rules:infrastructure-changes:
  rules:
    - changes:
        - "infrastructure/**/*"
        - "Dockerfile*"
        - "docker-compose*.yml"
        - "kubernetes/**/*"
        - "terraform/**/*"

.rules:ci-changes:
  rules:
    - changes:
        - ".gitlab-ci.yml"
        - ".gitlab/**/*"

# Environment-specific rules
.rules:deploy-staging:
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH =~ /^release\/.*/
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual

.rules:deploy-production:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual

# Feature flag based rules
.rules:feature-enabled:
  rules:
    - if: '$FEATURE_FLAG == "true"'

.rules:security-scan-enabled:
  rules:
    - if: '$ENABLE_SECURITY_SCANS == "true"'

.rules:matrix-build-enabled:
  rules:
    - if: '$ENABLE_MATRIX_BUILDS == "true"'

# Complex conditional rules
.rules:emergency-deploy:
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[emergency\]/'
    - if: '$EMERGENCY_DEPLOY == "true"'
      when: manual

.rules:skip-on-draft:
  rules:
    - if: '$CI_MERGE_REQUEST_TITLE =~ /^Draft:/'
      when: never
    - if: '$CI_MERGE_REQUEST_TITLE =~ /^WIP:/'
      when: never
    - when: on_success

# Tag-based rules
.rules:release-tag:
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

.rules:pre-release-tag:
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+-(alpha|beta|rc)\d+$/